version: '3.8'

services:
  # --- Unified Gateway ---
  gateway:
    image: nginx:alpine
    container_name: trading-gateway
    ports:
      - "8088:80" # High port to avoid conflicts
    volumes:
      - ./infrastructure/gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - trading-network
    depends_on:
      - dashboard
      - backend-api
      - grafana
    profiles:
      - app
      - expose

  # --- Configuration Overrides ---
  dashboard:
    environment:
      - NEXT_PUBLIC_API_URL=/api/v1
      - NEXT_PUBLIC_WS_URL=/
    profiles:
      - app
      - expose

  grafana:
    environment:
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    profiles:
      - app
      - expose

  # --- Exposure Tunnel (Optional/Automated) ---
  # This container can be toggled to provide a public URL instantly
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: trading-tunnel
    command: tunnel --url http://gateway:80
    depends_on:
      - gateway
    networks:
      - trading-network
    profiles:
      - expose

networks:
  trading-network:
    external: true
    name: trading-system_trading-network
