# Layer 4: Analysis Service ðŸ§ 

## **What is this?**

The Analysis Layer is the "Brain" of the system. Written in **Golang**, it performs computationally intensive technical analysis on the candles generated by Layer 2. It does not just store data; it understands it.

## **Why is it needed?**

- **Insight Generation**: Raw prices don't tell you to buy or sell. Indicators like **RSI** (Relative Strength Index) and **EMA** (Exponential Moving Average) do.
- **Parallelism**: Analyzing 50+ stocks with complex math requiring loop-backs is heavy. This layer distributes the load.

## **How it works**

1.  **Worker Pool Pattern**:
    - Spawns a fixed pool of **Goroutines** (lightweight threads).
    - A dispatcher assigns stocks (e.g., RELIANCE, TCS) to available workers.
2.  **Technical Calculation**:
    - Fetches the last `N` candles from TimeScaleDB.
    - Computes:
      - **RSI (14)**: Momentum indicator.
      - **EMA (9, 21, 50, 200)**: Trend indicators.
      - **MACD**: Trend-following momentum.
3.  **Metric Publishing**:
    - Serializes analysis results into JSON.
    - Publishes to Redis Channel: `analysis_updates` for Layer 5 to consume.
    - Updates System Metrics: `system:layer4:metrics` (tracks active goroutines/latency).

## **Key Logs & Monitoring**

- `[INFO] Analysis Cycle Started`: Triggered every defined interval.
- `[DEBUG] Analyzed HDFC. RSI: 65.4`: Shows calculated values.
- `[METRIC] Goroutines: 55`: Shows concurrency level.

## **Configuration**

- `WORKER_POOL_SIZE`: Number of parallel analysis threads (default: 10).
