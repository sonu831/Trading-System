generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model api_keys {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  user_id     Int?
  vendor_name String?
  is_active   Boolean  @default(true)
  rate_limit  Int      @default(10)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  users       users?   @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([key], map: "idx_api_keys_key")
}

model audit_log {
  id          Int      @default(autoincrement())
  time        DateTime @default(now()) @db.Timestamptz(6)
  event_type  String
  entity_type String?
  entity_id   String?
  action      String?
  details     Json?
  user_id     Int?

  @@id([time, id])
  @@index([time(sort: Desc)])
}

model backfill_jobs {
  id            Int       @id @default(autoincrement())
  job_id        String?   @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  status        String?   @default("PENDING")
  symbols       String[]
  timeframe     String?
  start_date    DateTime? @db.Date
  end_date      DateTime? @db.Date
  total_records BigInt?   @default(0)
  processed     BigInt?   @default(0)
  errors        Json?     @default("[]")
  started_at    DateTime? @db.Timestamptz(6)
  completed_at  DateTime? @db.Timestamptz(6)
  triggered_by  String?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([status], map: "idx_backfill_jobs_status")
}

/// This table has subclasses and requires additional setup for migrations. Visit https://pris.ly/d/table-inheritance for more info.
/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model candles_1m {
  time       DateTime  @db.Timestamptz(6)
  symbol     String
  exchange   String?   @default("NSE")
  open       Decimal   @db.Decimal(12, 2)
  high       Decimal   @db.Decimal(12, 2)
  low        Decimal   @db.Decimal(12, 2)
  close      Decimal   @db.Decimal(12, 2)
  volume     BigInt?   @default(0)
  vwap       Decimal?  @db.Decimal(12, 2)
  trades     Int?      @default(0)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@id([time, symbol])
  @@unique([symbol, time], map: "unique_candle_per_minute")
  @@index([time(sort: Desc)])
  @@index([symbol, time(sort: Desc)], map: "idx_candles_1m_symbol_time")
}

model data_availability {
  id            Int       @id @default(autoincrement())
  symbol        String
  timeframe     String
  first_date    DateTime  @db.Date
  last_date     DateTime  @db.Date
  total_records BigInt?   @default(0)
  gaps          Json?     @default("[]")
  quality_score Decimal?  @db.Decimal(5, 2)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([symbol, timeframe])
  @@index([symbol], map: "idx_data_availability_symbol")
}

model instruments {
  id          Int       @id @default(autoincrement())
  symbol      String    @unique
  name        String
  isin        String?
  exchange    String?   @default("NSE")
  sector_id   Int?
  industry    String?
  lot_size    Int?      @default(1)
  tick_size   Decimal?  @default(0.05) @db.Decimal(6, 2)
  token       String?
  is_nifty50  Boolean?  @default(false)
  is_active   Boolean?  @default(true)
  listed_date DateTime? @db.Date
  face_value  Decimal?  @db.Decimal(10, 2)
  market_cap  BigInt?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  sectors     sectors?  @relation(fields: [sector_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([sector_id], map: "idx_instruments_sector")
}

model invoices {
  id             Int       @id @default(autoincrement())
  user_id        Int?
  payment_id     Int?
  invoice_number String    @unique
  amount         Decimal   @db.Decimal(10, 2)
  tax            Decimal?  @default(0) @db.Decimal(10, 2)
  total          Decimal   @db.Decimal(10, 2)
  status         String?   @default("DRAFT")
  due_date       DateTime? @db.Date
  paid_at        DateTime? @db.Timestamptz(6)
  pdf_url        String?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  payments       payments? @relation(fields: [payment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users          users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id], map: "idx_invoices_user")
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model market_breadth {
  time                 DateTime @db.Timestamptz(6)
  advancing            Int?
  declining            Int?
  unchanged            Int?
  ad_ratio             Decimal? @db.Decimal(6, 4)
  new_highs            Int?
  new_lows             Int?
  above_vwap_pct       Decimal? @db.Decimal(5, 2)
  above_200ema_pct     Decimal? @db.Decimal(5, 2)
  mcclellan_oscillator Decimal? @db.Decimal(8, 4)

  @@id([time])
  @@index([time(sort: Desc)])
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model options_chain {
  time          DateTime @db.Timestamptz(6)
  symbol        String
  expiry        DateTime @db.Date
  strike        Decimal  @db.Decimal(10, 2)
  option_type   String
  ltp           Decimal? @db.Decimal(10, 2)
  open_interest BigInt?
  volume        BigInt?
  iv            Decimal? @db.Decimal(8, 4)
  delta         Decimal? @db.Decimal(8, 4)
  gamma         Decimal? @db.Decimal(8, 4)
  theta         Decimal? @db.Decimal(8, 4)
  vega          Decimal? @db.Decimal(8, 4)
  bid           Decimal? @db.Decimal(10, 2)
  ask           Decimal? @db.Decimal(10, 2)

  @@id([time, symbol, expiry, strike, option_type])
  @@index([symbol, expiry, strike, option_type, time(sort: Desc)], map: "idx_options_symbol_expiry")
  @@index([time(sort: Desc)])
}

model payments {
  id                 Int            @id @default(autoincrement())
  user_id            Int?
  subscription_id    Int?
  amount             Decimal        @db.Decimal(10, 2)
  currency           String?        @default("INR")
  status             String?        @default("PENDING")
  payment_method     String?
  gateway_order_id   String?
  gateway_payment_id String?
  metadata           Json?          @default("{}")
  created_at         DateTime?      @default(now()) @db.Timestamptz(6)
  completed_at       DateTime?      @db.Timestamptz(6)
  invoices           invoices[]
  subscriptions      subscriptions? @relation(fields: [subscription_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users              users?         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([status], map: "idx_payments_status")
  @@index([user_id], map: "idx_payments_user")
}

model plans {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  display_name  String
  description   String?
  price_monthly Decimal?        @default(0) @db.Decimal(10, 2)
  price_yearly  Decimal?        @default(0) @db.Decimal(10, 2)
  currency      String?         @default("INR")
  features      Json?           @default("{}")
  is_active     Boolean?        @default(true)
  created_at    DateTime?       @default(now()) @db.Timestamptz(6)
  subscriptions subscriptions[]
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model sector_strength {
  time           DateTime @db.Timestamptz(6)
  sector         String
  strength_score Decimal? @db.Decimal(5, 4)
  rotation_phase String?
  top_stock      String?
  bottom_stock   String?

  @@id([time, sector])
  @@index([time(sort: Desc)])
}

model sectors {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  display_name String?
  description  String?
  weight       Decimal?      @db.Decimal(5, 2)
  created_at   DateTime?     @default(now()) @db.Timestamptz(6)
  instruments  instruments[]
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model signals {
  id               Int      @default(autoincrement())
  time             DateTime @default(now()) @db.Timestamptz(6)
  signal_type      String
  strength         String?
  instrument       String
  entry_price      Decimal? @db.Decimal(10, 2)
  stop_loss        Decimal? @db.Decimal(10, 2)
  target           Decimal? @db.Decimal(10, 2)
  confidence       Decimal? @db.Decimal(5, 2)
  composite_score  Decimal? @db.Decimal(5, 4)
  trend_score      Decimal? @db.Decimal(5, 4)
  breadth_score    Decimal? @db.Decimal(5, 4)
  momentum_score   Decimal? @db.Decimal(5, 4)
  options_score    Decimal? @db.Decimal(5, 4)
  sector_score     Decimal? @db.Decimal(5, 4)
  volatility_score Decimal? @db.Decimal(5, 4)
  nifty_price      Decimal? @db.Decimal(10, 2)
  market_regime    String?
  executed         Boolean? @default(false)
  notes            String?

  @@id([time, id])
  @@index([time(sort: Desc)])
}

model subscriptions {
  id            Int        @id @default(autoincrement())
  user_id       Int?
  plan_id       Int?
  status        String?    @default("ACTIVE")
  billing_cycle String?    @default("MONTHLY")
  start_date    DateTime   @db.Date
  end_date      DateTime   @db.Date
  auto_renew    Boolean?   @default(true)
  cancelled_at  DateTime?  @db.Timestamptz(6)
  created_at    DateTime?  @default(now()) @db.Timestamptz(6)
  payments      payments[]
  plans         plans?     @relation(fields: [plan_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users         users?     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([status], map: "idx_subscriptions_status")
  @@index([user_id], map: "idx_subscriptions_user")
}

model system_config {
  key         String    @id
  value       Json
  description String?
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_by  String?
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model technical_indicators {
  time             DateTime @db.Timestamptz(6)
  symbol           String
  timeframe        String
  ema_9            Decimal? @db.Decimal(12, 2)
  ema_21           Decimal? @db.Decimal(12, 2)
  ema_50           Decimal? @db.Decimal(12, 2)
  ema_200          Decimal? @db.Decimal(12, 2)
  sma_20           Decimal? @db.Decimal(12, 2)
  rsi_14           Decimal? @db.Decimal(8, 4)
  macd             Decimal? @db.Decimal(12, 4)
  macd_signal      Decimal? @db.Decimal(12, 4)
  macd_histogram   Decimal? @db.Decimal(12, 4)
  atr_14           Decimal? @db.Decimal(12, 4)
  bb_upper         Decimal? @db.Decimal(12, 2)
  bb_middle        Decimal? @db.Decimal(12, 2)
  bb_lower         Decimal? @db.Decimal(12, 2)
  vwap             Decimal? @db.Decimal(12, 2)
  obv              BigInt?
  trend_score      Decimal? @db.Decimal(5, 4)
  momentum_score   Decimal? @db.Decimal(5, 4)
  volatility_score Decimal? @db.Decimal(5, 4)

  @@id([time, symbol, timeframe])
  @@index([symbol, timeframe, time(sort: Desc)], map: "idx_tech_indicators_symbol_tf")
  @@index([time(sort: Desc)])
}

model trading_calendar {
  date           DateTime  @id @db.Date
  is_trading_day Boolean?  @default(true)
  holiday_name   String?
  market_open    DateTime? @default(dbgenerated("'09:15:00'::time without time zone")) @db.Time(6)
  market_close   DateTime? @default(dbgenerated("'15:30:00'::time without time zone")) @db.Time(6)
  is_special     Boolean?  @default(false)
  notes          String?
}

model user_alerts {
  id           Int       @id @default(autoincrement())
  user_id      Int?
  symbol       String?
  alert_type   String
  condition    String
  threshold    Decimal?  @db.Decimal(12, 2)
  is_active    Boolean?  @default(true)
  triggered_at DateTime? @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  users        users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([symbol], map: "idx_user_alerts_symbol")
  @@index([user_id], map: "idx_user_alerts_user")
}

model user_subscribers {
  id                 Int       @id @default(autoincrement())
  chat_id            String    @unique
  username           String?
  email              String    @unique
  subscribed_at      DateTime? @default(now()) @db.Timestamptz(6)
  is_active          Boolean?  @default(true)
  user_id            Int?
  is_verified        Boolean?  @default(false)
  verification_token String?
  preferences        Json?     @default("{}")
  users              users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model user_suggestions {
  id         Int       @id @default(autoincrement())
  username   String?
  message    String
  source     String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

model user_watchlists {
  id         Int       @id @default(autoincrement())
  user_id    Int?
  name       String
  symbols    String[]
  is_default Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model users {
  id               Int                @id @default(autoincrement())
  telegram_id      BigInt?            @unique
  email            String?
  phone            String?
  name             String?
  is_premium       Boolean?           @default(false)
  is_active        Boolean?           @default(true)
  settings         Json?              @default("{}")
  created_at       DateTime?          @default(now()) @db.Timestamptz(6)
  last_active      DateTime?          @db.Timestamptz(6)
  invoices         invoices[]
  payments         payments[]
  subscriptions    subscriptions[]
  user_alerts      user_alerts[]
  user_subscribers user_subscribers[]
  user_watchlists  user_watchlists[]
  api_keys         api_keys[]

  @@index([email], map: "idx_users_email")
  @@index([telegram_id], map: "idx_users_telegram")
}

model system_notifications {
  id         Int       @id @default(autoincrement())
  type       String
  message    String    
  metadata   Json?     @default("{}")
  is_read    Boolean   @default(false)
  created_at DateTime  @default(now()) @db.Timestamptz(6)

  @@index([created_at(sort: Desc)])
  @@index([is_read])
}
